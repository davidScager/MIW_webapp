<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>BitBank - Registreren</title>
    <link href="BaseLayoutOld.css" rel="stylesheet" type="text/css"/>
    <link href="portfolio.css" rel="stylesheet" type="text/css"/>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="HomeSchermIngelogd.js"></script>

    <script>

       $( document ).ready(function() {
           console.log( "ready!" );
           let token = localStorage.getItem("token")
           console.log("Token in portfolio.html: " + token)
           if(token !== null){
               loadPortfolio(token);
           } else {
               document.getElementById("login/logoutButton").innerHTML = "Login"
           }
           //loadAssets();
           //alert("Ready")
           loadAssetsV2("false")
       });

       $( window ).resize(function() {
            setHeightsWidths();
            //alert("Resized?")
       });

       function setHeightsWidths(){
            // Viewport
            var new_height = $( window ).height();
            new_height = new_height -400
            $(".scroll_tbody").height(new_height);

            // Scrollable table shit, column can only set correct with a width
            setColumnWidth("#selectable_portfolio",".col_1", 15)
            setColumnWidth("#selectable_portfolio",".col_2", 45)
            setColumnWidth("#selectable_portfolio",".col_3", 15)
            setColumnWidth("#selectable_portfolio",".col_4", 15)
            setColumnWidth("#selectable_portfolio",".col_5", 10)

            setColumnWidth("#selectable_assets",".col_1", 15)
            setColumnWidth("#selectable_assets",".col_2", 40)
            setColumnWidth("#selectable_assets",".col_3", 15)
            setColumnWidth("#selectable_assets",".col_4", 15)
            setColumnWidth("#selectable_assets",".col_5", 15)
       }

       // Scrollable table column can only set correct with a width
       function setColumnWidth(tableId, columnClass, percentage){
            var tableWidth = $(tableId).width();
            //console.log( "tableWidth " +tableWidth);
            // VB $('#selectable_portfolio  .col_1').width(parseInt(600/3))
            var columnRef = tableId+" "+columnClass;
            // Width moet int zijn
            //console.log( "columnRef " +columnRef +" width "+parseInt((tableWidth/100) * percentage));
            $(columnRef).width(parseInt((tableWidth/100) * percentage))
        }

        // When the user clicks on <span> (x), close the modal
       function closeDialog() {
           var modal = document.getElementById("assetDialog");
           modal.style.display = "none";
           var modal = document.getElementById("assetDialogbuy");
           modal.style.display = "none";
       }



       // When the user clicks anywhere outside of the modal, close it
       window.onclick = function(event) {
           var modal = document.getElementById("assetDialog");
           if (event.target == modal) {
               modal.style.display = "none";
           }
           var modal = document.getElementById("assetDialogbuy");
           if (event.target == modal) {
               modal.style.display = "none";
           }

       }

       function buyAsset(symbol, name){
            //alert("Buy "+symbol+" name "+name)
            var element = document.getElementById("dialog_header_buy");
            element.innerText = "Buy: "+ symbol;
            var modal = document.getElementById("assetDialogbuy");
            modal.style.display = "block";
            var assetName = document.getElementById("dialog_asset_name_buy");
            assetName.innerText = "Buy: "+name;

            var symbolElem = document.getElementById("symbol_to_buy");
            symbolElem.value = symbol;

       }

       function assetForSale(symbol, name){
            //alert("Buy "+symbol+" name "+name)
            var element = document.getElementById("dialog_header");
            element.innerText = "For sale: "+ symbol;
            var modal = document.getElementById("assetDialog");
            modal.style.display = "block";
            var assetName = document.getElementById("dialog_asset_name");
            assetName.innerText = name;
            var symbolElem = document.getElementById("symbol_for_sale");
            symbolElem.value = symbol;
       }

       function updateBuyAsset(token){
            let symbol = document.getElementById("symbol_to_buy").value;
            let amountUsd = document.getElementById("amountToBuyUSD").value;
            let payWith = $( "#payWith option:selected" ).val();
            alert("symbol " + symbol+ " amountUsd "+ amountUsd + " payWith "+payWith);

            fetch("http://localhost:8080/updatebuyasset", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    "Authorization": "Bearer " + token,
                },
                body: JSON.stringify({
                    symbol: symbol,
                    amountUsd: amountUsd,
                    payWith: payWith
                })
            })
            .then(response => response.text())
            .then(response => {
                alert(response);
                console.log(response);
            })

       }

       function updateAssetForSale(token) {
            // url
            let symbolElem = document.getElementById("symbol_for_sale");
            let symbol = symbolElem.value
            console.log(symbol)
            let amountForSaleElem = document.getElementById("amountForSale");
            let amount = amountForSaleElem.value
            console.log(amount)
            //alert("symbolElem "+ amountForSaleElem.value+"  "+ symbolElem.value)

            console.log("updateAssetForSale() aangeroepen voor token " + token)
            if (token === null) {
                console.log("SessionNotValid() aangeroepen voor token " + token)
                sessionNotValid()
            } else {
                let dataObj = {
                    symbol: symbol,
                    amount: amount
                };
                console.log("Start ajax");
                $.ajaxSetup({
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        "Authorization": "Bearer " + token,
                    }
                });
                $.ajax({
                    url: 'http://localhost:8080/updateassetforsale',
                    type: 'POST',
                    dataType: 'text',
                    contentType: "application/json",
                     data: JSON.stringify({
                        symbol: symbol,
                        amount: amount
                    }),

                    success: function (data) {
                        //console.log( data );
                        //var json_str = JSON.stringify(data);
                        //console.log( JSON.stringify(data) );
                        let token = localStorage.getItem("token")
                        loadPortfolio(token);
                        alert(data);
                        closeDialog();
                    },
                    error: function(error, errorThrown){
                        var json_str = JSON.stringify(error);
                        console.log( JSON.stringify(error) );
                        alert('error!'+json_str);
                        closeDialog();
                    }
                })

            }
       }

       function loadAssetsV2(update) {
            // Leeg table assests
            $('#selectable_assets > tbody').empty();
            $.getJSON("http://localhost:8080/updateassetsbyapiv2?update="+update, function (data) {
                var json_str = JSON.stringify(data);
                var asset_row = '';
                for (i in data) {
                    console.log("json row");
                    console.log(JSON.stringify(data[i]));
                    asset_row += '<tr onclick="buyAsset(\'' + data[i].abbreviation + '\',\'' + data[i].name + '\');" id="asset_row" class="ui-widget-content asset_row">';
                    asset_row += '   <td class="col_1">' + data[i].abbreviation + '</td>';
                    asset_row += '   <td class="col_2"  title="' + data[i].description + '">' + data[i].name + '</td>';
                    asset_row += '   <td class="col_3">' + data[i].valueInUsd + '</td>';
                    asset_row += '   <td class="col_4">' + data[i].availableBank + '</td>';
                    asset_row += '   <td class="col_5">' + data[i].availableOthers + '</td>';
                    asset_row += '</tr>';
                }
                console.log(asset_row);
                $('#selectable_assets > tbody').append(asset_row);
                setHeightsWidths();
            });

       }

       // oud
       function loadAssets() {
            $('#selectable_assets > tbody').empty();
            $.getJSON("http://localhost:8080/updateassetsbyapi", function (data) {
                var json_str = JSON.stringify(data);
                var asset_row = '';
                for (i in data) {
                    console.log("jow");
                    console.log(JSON.stringify(data[i]));
                    // Append table row
                    asset_row += '<tr onclick="buyAsset(\'' + data[i].abbreviation + '\',\'' + data[i].name + '\');" id="asset_row" class="ui-widget-content asset_row">';
                    asset_row += '   <td class="col_1">' + data[i].abbreviation + '</td>';
                    asset_row += '   <td class="col_2"  title="' + data[i].description + '">' + data[i].name + '</td>';
                    asset_row += '   <td class="col_3">' + data[i].valueInUsd + '</td>';
                    asset_row += '   <td class="col_4">' + data[i].valueYesterday + '</td>';
                    asset_row += '   <td class="col_5">' + data[i].valueLastWeek + '</td>';
                    asset_row += '   <td class="col_6">' + data[i].valueLastMonth + '</td>';
                    asset_row += '</tr>';

                }
                console.log(asset_row);
                $('#selectable_assets > tbody').append(asset_row);
                setHeightsWidths();
            });

       }

       // Doe 2 dingen update portfolio en paywith indien buy
       function loadPortfolio(token) {
            console.log("Loadportfolio() aangeroepen voor token " + token)
            if (token === null) {
                console.log("SessionNotValid() aangeroepen voor token " + token)
                sessionNotValid()
            } else {
                $.ajaxSetup({
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                         "Authorization": "Bearer " + token
                    }
                });

                // Leeg select  assets in portfolio
                $('#selectable_portfolio > tbody').empty();

                // Leeg select available assets portfolio to pay with
                // https://stackoverflow.com/questions/47824/how-do-you-remove-all-the-options-of-a-select-box-and-then-add-one-option-and-se
                $('#payWith').find('option').remove().end();

                $.post("http://localhost:8080/listportfolio",
                {
                    extra: "hille"
                },
                function (data, status) {
                    var json_str = JSON.stringify(data);
                    console.log(JSON.stringify(data));
                    var asset_row = '';
                    for (i in data) {
                        console.log("json row");
                        console.log(JSON.stringify(data[i]));
                        asset_row += '<tr onclick="assetForSale(\'' + data[i].assetName + '\',\'' + data[i].assetDescription + '\');" id="asset_row" class="ui-widget-content asset_row">';
                        asset_row += '   <td class="col_1">' + data[i].assetName + '</td>';
                        asset_row += '   <td class="col_2">' + data[i].assetDescription + '</td>';
                        asset_row += '   <td class="col_3">' + data[i].amount + '</td>';
                        asset_row += '   <td class="col_4">' + Math.round((data[i].amountUSD * data[i].amount * 100)) / 100 + '</td>';
                        asset_row += '   <td class="col_5">' + data[i].forSale + '</td>';
                        asset_row += '</tr>';
                        //Append select available assets in portfolio to buy with
                        // https://www.geeksforgeeks.org/how-to-add-options-to-a-select-element-using-jquery/
                        $('#payWith').append(new Option(data[i].assetDescription, data[i].assetName));

                    }

                    $('#selectable_portfolio > tbody').append(asset_row);
                        setHeightsWidths();
                    }
                );
            }
       }

       function sessionNotValid() {
            alert("Sessie is niet geldig, log (opnieuw) in")
       }

       function loadPortfolioForAssetChoice(token) {
                console.log("Loadportfolio() aangeroepen voor token " + token)
                if (token === null) {
                    console.log("SessionNotValid() aangeroepen voor token " + token)
                    sessionNotValid()
                } else {
                    $.ajaxSetup({
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            "Authorization": "Bearer " + token
                        }
                    });

                    $('#availablecurrencies > tbody').empty();
                    $.post("http://localhost:8080/listportfolio",
                        {
                            extra: "hille"
                        },
                        function (data, status) {
                            var json_str = JSON.stringify(data);
                            console.log(JSON.stringify(data));
                            var asset_row = '';
                            for (i in data) {
                                console.log("json row");
                                console.log(JSON.stringify(data[i]));
                                asset_row +=   data[i].assetName + '</td>';
                            }

                            $('#availablecurrencies > tbody').append(asset_row);

                        }
                    );
                }
            }

            function sessionNotValid() {
                alert("Sessie is niet geldig, log (opnieuw) in")
       }




    </script>
</head>

<body style="background-color: #2B2B2B" ;>

<header>
    <div class="container">
        <nav>
            <ul class="nav_links ">
                <li><a href="Transaction.html">Handelen</a></li>
                <li><a href="portfolio.html">Portfolio</a></li>
                <li><a href="TransactionHistory.html">Transacties</a></li>
                <li><a href="HomeScherm.html"><img src="images/logo.png" class="logo" alt="BitBank-logo"></a></li>
                <li id="login/logoutButton"><a href="login.html">Logout</a></li>
                <li><a class="cta" href="contact.html">
                    <button>Contact</button>
                </a></li>
            </ul>
        </nav>

    </div>
</header>

<!-- Portfolio page.-->
<main class="asset-box">
    <input type="hidden" id="token_id" name="token_id" value="my_hidden_token">
    <!-- Portfolio block.-->
    <div class="asset-form">
        <h1>Portfolio</h1>
        <table id="selectable_portfolio" class="scroll_table">
            <thead class="scroll_thead">
            <tr class="ui-widget-content scroll_tr">
                <th class="col_1">Coin</th>
                <th class="col_2">Naam</th>
                <th class="col_3">Aantal</th>
                <th class="col_4">Value USD</th>
                <th class="col_5">For sale</th>
            </tr>
            </thead>
            <tbody class="scroll_tbody">

            </tbody>
        </table>
        <button onclick="loadPortfolio(checkToken());">Ververs portfolio</button>
    </div>
    <!-- Asset page.-->
    <!--  old
    <div class="koers-form">
        <h1>Live Koers</h1>
        <table id="selectable_assets" class="scroll_table">
            <thead class="scroll_thead">
            <tr class="ui-widget-content">
                <th class="col_1">Coin</th>
                <th class="col_2">Naam</th>
                <th class="col_3">Prijs</th>
                <th class="col_4">Gisteren</th>
                <th class="col_5" title="Last Week">L/W</th>
                <th class="col_6" title="Last Month">L/M</th>
            </tr>
            </thead>
            <tbody class="scroll_tbody">
            </tbody>
        </table>

        <button onclick="loadAssets();">Ververs koers</button>
    </div>
    --->
    <div class="koers-form">
        <h1>Live Koers en beschikbaar</h1>
        <table id="selectable_assets" class="scroll_table">
            <thead class="scroll_thead">
            <tr class="ui-widget-content">
                <th class="col_1">Coin</th>
                <th class="col_2">Naam</th>
                <th class="col_3">Prijs</th>
                <th class="col_4">Bank</th>
                <th class="col_5" title="Beschikbaar van ander klanten">Others</th>
            </tr>
            </thead>
            <tbody class="scroll_tbody">
            </tbody>
        </table>

        <button onclick="loadAssetsV2('true');">Ververs en update naar laatste koers</button>
    </div>

</main>
<!-- End Portfolio page.-->

<footer>
    <img class="BLeft" src="images/B left.png" alt="BLeft">
    <img class="BRight" src="images/B right.png" alt="Bright">
</footer>
</body>

<!-- The Modal -->
<div id="assetDialog" class="modal">
    <!-- Modal content -->
    <div class="modal-content asset-buy">
        <div class="modal-header">
            <div id="dialog_header" class="as_h1"></div>
            <div class="close" onclick="closeDialog();">&times;</div>
        </div>
        <div class="body_dialog_sale">
            <h2 id="dialog_asset_name"></h2>
            <label for="forSale">For Sale:</label>
            <input type="text" id="amountForSale" name="amountForSale" value="0" required>
            <hidden id="symbol_for_sale" name="symbol_for_sale" value=""/>
            <button onclick="updateAssetForSale(checkToken());">Available for sale!</button>
        </div>


    </div>

</div>

<div id="assetDialogbuy" class="modal">
    <!-- Modal content -->
    <div class="modal-content asset-buy">
        <div class="modal-header">
            <div id="dialog_header_buy" class="as_h1"></div>
            <div class="close" onclick="closeDialog();">&times;</div>
        </div>
        <div class="body_dialog_sale">
            <h2 id="dialog_asset_name_buy"></h2>
            <label for="toBUy">To buy in USD: </label>
            <input type="text" id="amountToBuyUSD" name="amountToBuyUSD" value="0" required>
            <hidden id="symbol_to_buy" name="symbol_to_buy" value=""/>
            <form id="myForm">
                <label for="currency">Pay with:</label>
                <select name="payWith" id="payWith">
                    <optgroup label="Uw beschikbare assets">
                        <option id="availablecurrencies"></option>

                    </optgroup>
                </select>
                <br><br>

                <button onclick="updateBuyAsset(checkToken());">Buy Assets!</button>
            </form>
        </div>


    </div>

</div>


</html>s